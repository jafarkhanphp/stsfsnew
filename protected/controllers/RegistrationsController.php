<?phpclass RegistrationsController extends Controller{	function actionUpdate_Pair_BV(){		$allMembers=Sponserdetails::model()->getAllImidateInsponser();			foreach($allMembers as $member){				$this->Create_Pair_Bv_New($member['ImmediateSponserId']);			 }			 Yii::app()->user->setFlash('success', '<i class="fa fa-check-circle"></i><strong> Successfully closing MBV  </strong>');		$this->redirect(array('user/closing/tab/'.base64_encode(2)));	}		function Create_Pair_Bv_New($id){		ini_set('max_execution_time',120); 		$currentDate=date('Y-m-d H:i:s');		$bv_rate=Settings::model()->getSiteSettingByName('bv_rate');		$bvDetails=Registrations::model()->bvDetailsByRid($id); 		$totalLeftBV=$bvDetails['tota_left_bv']; 		$totalRightBV= $bvDetails['total_right_bv']; 		$agg_bv=$bvDetails['total_mbv']; 		if($agg_bv>0){			$getBaneryDetails=Binaryincome::model()->getBinaryDetailByRid($id);				if(!empty($getBaneryDetails)){					$agg_left_bv=$totalLeftBV;					$agg_right_bv=$totalRightBV;					$left_bv=$agg_left_bv-$getBaneryDetails['agg_left_bv'];					$right_bv=$totalRightBV-$getBaneryDetails['agg_right_bv'];						$balance_left_bv=abs($agg_bv-$totalLeftBV);					$balance_right_bv=abs($agg_bv-$totalRightBV);					$total_bv=$agg_bv-$getBaneryDetails['agg_bv'];					$caping=Settings::model()->getSiteSettingByName('caping');					if($total_bv>$caping){						$total_bv_amt='25000';						$getCaping=$caping;					} else{						$total_bv_amt=$total_bv*$bv_rate;						$getCaping='';					}					if($caping!=0){						$laps=$total_bv-$caping;					} else{						$laps=0;					}															} else {							$agg_left_bv=$totalLeftBV;							$agg_right_bv=$totalRightBV;							$left_bv=$totalLeftBV;							$right_bv=$totalRightBV;								$balance_left_bv=abs($agg_bv-$totalLeftBV);							$balance_right_bv=abs($agg_bv-$totalRightBV);							$total_bv=$agg_bv;							$caping=Settings::model()->getSiteSettingByName('caping');							if($total_bv>$caping){							 $total_bv_amt='25000';							 $getCaping=$caping;							} else{								$total_bv_amt=$total_bv*$bv_rate;								$getCaping='';							}							if($caping!=0){								$laps=$total_bv-$caping;							} else{								$laps=0;							}				}						$model=new Binaryincome;						if(Binaryincome::model()->RidExist($id, $agg_bv)==0){													 $query=Yii::app()->db->createCommand()->insert('binaryincomes', array('RID'=>$id,'agg_left_bv'=>$agg_left_bv, 							 'agg_right_bv'=>$agg_right_bv, 'left_bv'=>$left_bv, 'right_bv'=>$right_bv, 'caping'=>$getCaping , 'laps'=>$laps ,							 'balance_left_bv'=>$balance_left_bv, 'balance_right_bv'=>$balance_right_bv, 							 'agg_bv'=>$agg_bv, 'total_bv'=>$total_bv,  'bv_rate'=>$bv_rate, 'total_bv_amt'=>$total_bv_amt, 							 'created_date'=>$currentDate, 'amount'=>$total_bv_amt, 'payment_status'=>0, 							 'created'=>$currentDate, 'created_by'=>3));						 						}					}	}				function Create_Pair_Bv($id){		ini_set('max_execution_time',120); 		$currentDate=date('Y-m-d H:i:s');		$sponserDetail2=Sponserdetails::model()->getLeftNodeRightNode($id);		$bv_rate=Settings::model()->getSiteSettingByName('bv_rate');							if(isset($sponserDetail2['LNode'])){				$Lnode2=$sponserDetail2['LNode'];				$BVLeft=Registrations::model()->getBvByRid($Lnode2);			} else {				$Lnode2=0;				$BVLeft=0;			}									if(isset($sponserDetail2['RNode'])){				$Rnode2=$sponserDetail2['RNode'];				$BVright=Registrations::model()->getBvByRid($Rnode2);			} else {				$Rnode2=0;				$BVright=0;			}						if($BVLeft!=0 && $BVright!=0){						 $totalLeftBV=Registrations::model()->getTotalBVLeft($Lnode2); 						 $totalRightBV= Registrations::model()->getTotalBVRight($Rnode2); 						//echo  $totalLeftBV.'--'.$totalRightBV.'<br>';						$totalLeftMember= Registrations::model()->getTotalMemberLeft($Lnode2); 						$totalRightMember= Registrations::model()->getTotalMemberRight($Rnode2);												//echo  $totalLeftMember.'--'.$totalRightMember;						//exit;										$agg_bv=($totalLeftBV < $totalRightBV)?($totalLeftBV):($totalRightBV);										$agg_pair=($totalLeftMember < $totalRightMember)?($totalLeftMember):($totalRightMember);												if($agg_bv>0){						$getBaneryDetails=Binaryincome::model()->getBinaryDetailByRid($id);						if(!empty($getBaneryDetails)){							$agg_left_bv=$totalLeftBV;							$agg_right_bv=$totalRightBV;							$left_bv=$agg_left_bv-$getBaneryDetails['agg_left_bv'];							$right_bv=$totalRightBV-$getBaneryDetails['agg_right_bv'];								$balance_left_bv=abs($agg_bv-$totalLeftBV);							$balance_right_bv=abs($agg_bv-$totalRightBV);							$total_bv=$agg_bv-$getBaneryDetails['agg_bv'];							// $total_bv; exit;							/* $getuserBV=Registrations::model()->getBvByRid($id);							if($getuserBV<=25){								$getCap=Settings::model()->getSiteSettingByName('caping_25bv');								$caping=($total_bv < $getCap)?('0'):($total_bv-$getCap);									$after_caping_bv =($total_bv < $getCap)?($total_bv):($total_bv-$getCap);							} else if($getuserBV<=50 & $getuserBV>25){								$getCap=Settings::model()->getSiteSettingByName('caping_50bv');									$caping=($total_bv < $getCap)?('0'):($total_bv-$getCap);									$after_caping_bv =($total_bv < $getCap)?($total_bv):($total_bv-$getCap);							} else  {								$getCap=Settings::model()->getSiteSettingByName('caping_100bv');								$caping=($total_bv < $getCap)?('0'):($total_bv-$getCap);									$after_caping_bv =($total_bv < $getCap)?($total_bv):($total_bv-$getCap);								}							$after_total_caping_bv=$getBaneryDetails['after_total_caping_bv']+$after_caping_bv;							if($caping!=0){								$laps=$total_bv-$caping;							} else{								$laps=0;							}														$total_laps=$getBaneryDetails['total_laps']+$laps;							*/							$total_bv_amt=$total_bv*$bv_rate; 							/**********************************************************/							$BalanceLeft=abs($agg_pair-$totalLeftMember);							$balanceRight=abs($agg_pair-$totalRightMember);							$balanceRight=abs($agg_pair-$totalRightMember);							$left_pair=$totalLeftMember-$getBaneryDetails['totalLeft'];							$right_pair=$totalRightMember-$getBaneryDetails['totalRight'];							$pair_count=$agg_pair-$getBaneryDetails['agg_pair'];							$amount= $pair_count*100;							$totalLeft=$totalLeftMember;							$totalRight=$totalRightMember;						} else {							$agg_left_bv=$totalLeftBV;							$agg_right_bv=$totalRightBV;							$left_bv=$totalLeftBV;							$right_bv=$totalRightBV;								$balance_left_bv=abs($agg_bv-$totalLeftBV);							$balance_right_bv=abs($agg_bv-$totalRightBV);							$total_bv=$agg_bv;							$getuserBV=Registrations::model()->getBvByRid($id);							/*if($getuserBV<=25){								$getCap=Settings::model()->getSiteSettingByName('caping_25bv');								$caping=($total_bv < $getCap)?('0'):($total_bv-$getCap);									$after_caping_bv =($total_bv < $getCap)?($total_bv):($total_bv-$getCap);							} else if($getuserBV<=50 & $getuserBV>25){								$getCap=Settings::model()->getSiteSettingByName('caping_50bv');									$caping=($total_bv < $getCap)?('0'):($total_bv-$getCap);									$after_caping_bv =($total_bv < $getCap)?($total_bv):($total_bv-$getCap);							} else  {								$getCap=Settings::model()->getSiteSettingByName('caping_100bv');								$caping=($total_bv < $getCap)?('0'):($total_bv-$getCap);									$after_caping_bv =($total_bv < $getCap)?($total_bv):($total_bv-$getCap);								}							$after_total_caping_bv=$after_caping_bv;							if($caping!=0){								$laps=$total_bv-$caping;							} else{								$laps=0;							}							$total_laps=$laps; */							$total_bv_amt=$total_bv*$bv_rate;														/**********************************************************/							$BalanceLeft=abs($agg_pair-$totalLeftMember);							$balanceRight=abs($agg_pair-$totalRightMember);							$left_pair=$totalLeftMember;							$right_pair=$totalRightMember;							$pair_count=$agg_pair-$getBaneryDetails['agg_pair'];							$amount= $pair_count*100;							$totalLeft=$totalLeftMember;							$totalRight=$totalRightMember;													}						$model=new Binaryincome;						if(Binaryincome::model()->RidExist($id, $agg_bv)==0){						 $query=Yii::app()->db->createCommand()->insert('binaryincomes', array('RID'=>$id,'agg_left_bv'=>$agg_left_bv, 						 'agg_right_bv'=>$agg_right_bv, 'left_bv'=>$left_bv, 'right_bv'=>$right_bv, 						 'balance_left_bv'=>$balance_left_bv, 'balance_right_bv'=>$balance_right_bv, 						 'agg_bv'=>$agg_bv, 'total_bv'=>$total_bv,  'bv_rate'=>$bv_rate, 'total_bv_amt'=>$total_bv_amt, 						 'BalanceLeft'=>$BalanceLeft, 'balanceRight'=>$balanceRight, 'left_pair'=>$left_pair, 						 'right_pair'=>$right_pair, 'totalLeft'=>$totalLeft, 'totalRight'=>$totalRight, 'agg_pair'=>$agg_pair, 						 'created_date'=>$currentDate, 'pair_count'=>$pair_count, 'amount'=>$amount, 'payment_status'=>0, 						 'created'=>$currentDate, 'created_by'=>3));						 												$connectionRight=Yii::app()->db;						 $sqlRight = "UPDATE  registrations SET agg_leftbv='$agg_left_bv', agg_rightbv='$agg_right_bv', agg_bv='$agg_bv'  						 WHERE Rid = '$id'";						$commandRight = $connectionRight->createCommand($sqlRight);						 $commandRight->execute();						 						}					}					}	}				public function actionDirect_Sponsers(){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		$model = new Registrations();		if(isset($_POST['Registrations'])){			$sponserID=$_POST['Registrations']['Rid'];			$usercode=Yii::app()->user->getState('usercode');			$sql="SELECT registrations.Rid, registrations.BinaryPosition, registrations.FirstName, registrations.RegistrationDate, packages.package_name,			registrations.ImmediateSponserId FROM registrations left join packages on packages.id=registrations.package_id where registrations.SponserID='$sponserID' ";				$command=Yii::app()->db->createCommand($sql);					$registrationDetailArray=$command->queryAll();		} else{			$usercode=Yii::app()->user->getState('usercode');			$sql="SELECT registrations.Rid, registrations.BinaryPosition, registrations.FirstName, registrations.RegistrationDate,packages.package_name,			registrations.ImmediateSponserId FROM registrations left join packages on packages.id=registrations.package_id where registrations.SponserID='$usercode' ";				$command=Yii::app()->db->createCommand($sql);					$registrationDetailArray=$command->queryAll();		}					$this->render('direct_sponsers',array('model'=>$model, 'registrationDetailArray'=>$registrationDetailArray));	}					public function actionNetwork(){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		$checkPermission=Yii::app()->session['permissions'];		if(!empty($checkPermission)){			if($checkPermission[0]['lists']!=0){				Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');				$this->redirect(array('/user/member_dashboard'));			}		}		$this->render('network',array('model'=>''));	}							public function actionMember_Network(){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 				$this->render('member_network',array('model'=>''));	}				public function actionIndex(){		$this->layout = false;			if(Yii::app()->user->id==''){  				Yii::app()->user->setFlash('error', "Please login again!");				$this->redirect(array('/site/login'));			} 			$checkPermission=Yii::app()->session['permissions'];			if($checkPermission[0]['lists']!=0){				Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');				$this->redirect(array('/user/dashboard'));			}		$model = new Registrations($scenario='search');		//$usercode=Yii::app()->user->getState('usercode');		$criteria = new CDbCriteria;		if(isset($_GET['Registrations'])){				$model->attributes=$_GET['Registrations'];				$criteria->addSearchCondition('t.Rid', $_GET['Registrations']['Rid']."%", 0);				$criteria->addSearchCondition('t.FirstName', $_GET['Registrations']['FirstName']."%", 0);				$criteria->addSearchCondition('t.package_id', $_GET['Registrations']['package_id']."%", 0);							}				//$criteria->join = 'left join packages as p ON p.id=t.package_id ';		//$criteria->select = 'p.*, t.*';		//$criteria->addCondition('s.Rid >'.$usercode);		//$criteria->order = 't.Rid Asc';						$dataProvider=new CActiveDataProvider('Registrations', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=> array('id'=>true),  ),				'pagination' => array ( 'PageSize' => 20,  ) ,		));		$this->render('index',array('dataProvider'=>$dataProvider,'model'=>$model));	}		public function actionView(){			$this->layout = false;			if(Yii::app()->user->id==''){  				Yii::app()->user->setFlash('error', "Please login again!");				$this->redirect(array('/site/login'));			} 			$Rid=base64_decode($_GET['id']);			$bankDetail=Bankdetails::model()->getBankDetasilById($Rid);			$this->render('view',array('model'=>$this->loadModel($Rid), 'bankDetail'=>$bankDetail ));	}		public function actiontest(){	 	$this->layout = false;		$sql='SELECT Rid, BinaryPosition  FROM registrations order by Rid ASC ';			$command=Yii::app()->db->createCommand($sql);				$registrationDetailArray=$command->queryAll();		//echo '<pre>';		//print_r($registrationDetailArray); exit;		foreach($registrationDetailArray as $details){			//$this->Update_Auto_Bv($details['Rid'], $details['BinaryPosition'], '25'); 		}		//print_r($registrationDetailArray);		}			function actionTt(){		$sql='SELECT * FROM registrations_old order by Rid ASC ';			$command=Yii::app()->db->createCommand($sql);				$registrationDetailArray=$command->queryAll();		//echo '<pre>';		//print_r($registrationDetailArray); 		$curentDate	 			= date('Y-m-d H:i:s');		$model=new Registrations; 		foreach($registrationDetailArray as $det){				$rr=Registrations::model()->checkSponserId($det['Rid']);		       if($rr==0){				Yii::app()->db->createCommand()->insert('registrations',							array('Rid'=>$det['Rid'], 'pin_id'=>$det['pin_id'],  							'package_id'=>$det['package_id'], 'package_amt'=>$det['package_amt'], 'bv'=>$det['bv'], 'Role'=>$det['Role'], 'SponserID'=>$det['SponserID'], 							'ImmediateSponserId'=>$det['ImmediateSponserId'], 'RegistrationDate'=>$det['RegistrationDate'], 							'Emailaddress'=>$det['Emailaddress'], 'BinaryPosition'=>$det['BinaryPosition'], 'DOB'=>$det['DOB'],							'ContactNo1'=>$det['ContactNo1'], 'FirstName'=>$det['FirstName'], 'fatherName'=>$det['fatherName'], 							'Sex'=>$det['Sex'], 'PanNo'=>$det['PanNo'], 'Address'=>$det['Address'], 'City'=>$det['City'], 'created'=>$det['created'],							'Status'=>$det['Status'], 'Level'=>$det['Level'], 'created_by'=>$det['created_by']));							$Rid=$det['Rid'];							$reffrelId=$det['ImmediateSponserId'];							$pKgAmt=$det['package_amt'];							$curentDate=$det['RegistrationDate'];							$levels=$det['Level'];																												$countSponser=Sponserdetails::model()->chechInsponserIDExistInSponserTable($reffrelId);														if($countSponser!=0){																if($det['BinaryPosition']=='Right'){																$connection=Yii::app()->db;																$sql = "UPDATE  sponserdetails SET  RSponserId = '$reffrelId', RNode='$Rid', 																RRFee='$pKgAmt', RRdate='$curentDate',  created='$curentDate' WHERE ImmediateSponserId = '$reffrelId'";																$command = $connection->createCommand($sql);																																													}else { 																$connection=Yii::app()->db;																$sql = "UPDATE  sponserdetails SET  LSponserId = '$reffrelId',  LNode='$Rid', 																RRFee='$pKgAmt', RRdate='$curentDate',  created='$curentDate' WHERE ImmediateSponserId = '$reffrelId'";																$command = $connection->createCommand($sql);																																												}														} else {															if($det['BinaryPosition']=='Right'){ //Insert New member																$query2=Yii::app()->db->createCommand()->insert('sponserdetails',																array('RSponserId'=>$reffrelId,'ImmediateSponserId'=>$reffrelId, 'RNode'=>$Rid, 																'RRFee'=>$pKgAmt, 'RRdate'=>$curentDate, 'created'=>$curentDate, 'Level'=>$levels));																																													}else { 																$connection=Yii::app()->db;														  		$query=Yii::app()->db->createCommand()->insert('sponserdetails',														   	   array('LSponserId'=>$reffrelId, 'ImmediateSponserId'=>$reffrelId, 'LNode'=>$Rid, 'LRFee'=>$pKgAmt, 															   'LRdate'=>$curentDate, 'created'=>$curentDate, 'Level'=>$levels));																																												}														}																											$this->Update_Auto_Bv($det['Rid'], $det['BinaryPosition'], $det['bv']); 				$this->Single_Leg($det['Rid']);			   }		}		//exit;											}					public function actionCreate(){	 	$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		$checkPermission=Yii::app()->session['permissions'];		if($checkPermission[0]['lists']!=0){			Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');			$this->redirect(array('/user/dashboard'));		}				$model=new Registrations;		$model->setScenario('insert');		$model1=new Sponserdetails;		$model3=new User;				// Uncomment the following line if AJAX validation is needed		// $this->performAjaxValidation($model); if($valid & $model4->validate() & $model2->validate()){		//$this->Update_Auto_Bv('10016776', 'Left', '25'); exit;		if(isset($_POST['Registrations'])){                        $model->attributes=$_POST['Registrations'];						//$model2->attributes=$_POST['Bankdetails'];                        $valid=$model->validate();                                    if($model->validate()){							$curentDate	 			= date('Y-m-d H:i:s');							$reffrelId=$_POST['Registrations']['SponserID'];							$packageId=$_POST['Registrations']['package_id'];							//Check Referal Id exist or Not//							$countRegistration=Registrations::model()->checkSponserId($reffrelId);							if($countRegistration==0){								Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Sponser Id not Match!</strong>');								$this->redirect(array('create'));							}														$pin_id=$_POST['Registrations']['pin_id'];							$checkPin=Pincreates::model()->checkPinByPinUserID($pin_id, Yii::app()->user->getState('usercode'), $packageId);							//echo $checkPin; exit;							if($checkPin==0 || $checkPin==""){								Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Invalid Pin No.!</strong>'); 								$this->redirect(array('create'));							}														$userPin=Pincreates::model()->getpinnoByid($_POST['Registrations']['pin_id']);														$bv=Packages::model()->getBvById($packageId);							$pKgAmt=Packages::model()->getAmountById($_POST['Registrations']['package_id']);							$Password=Yii::app()->myclass->getUniquePassword();							$mobile=$_POST['Registrations']['ContactNo1'];														$BinaryPosition=$_POST['Registrations']['BinaryPosition'];							 if($BinaryPosition=='Left'){								$nodePosation='LNode';							 } else {								$nodePosation='RNode';							 }														 							//Check Referal Id exist or Not//																	$sponserDetails=$this->getLastNode($reffrelId,$nodePosation);										$sponserNodeCount=$this->getLastNodeCount($reffrelId,$nodePosation);										//print_r('<pre>');   print_r($sponserDetails);   print_r('</pre>');  exit;									if(!empty($sponserDetails)){												if($BinaryPosition=='Left'){												 $nodes=$sponserDetails['LNode'];											 } else {												$nodes=$sponserDetails['RNode'];											 }																					while($sponserNodeCount>0){												if($nodes!=""){													if($BinaryPosition=='Left'){														$reffrelId=$sponserDetails['LNode'];													 } else {														$reffrelId=$sponserDetails['RNode'];													 }												}												$sponserDetails=$this->getLastNode($reffrelId,$nodePosation);												$sponserNodeCount=$this->getLastNodeCount($reffrelId,$nodePosation);											}																																	$levelDetails=$this->getLevelByRid($reffrelId);										if($levelDetails!=''){												$levels=($levelDetails)+1;												$model->pin_id  					= $pin_id;												$model->package_id  				= $packageId;												$model->package_amt   				= $pKgAmt;												$model->bv 							= $bv;												$model->Role 						= 'S';												$model->SponserID					=	$_POST['Registrations']['SponserID'];												$model->ImmediateSponserId 			=  $reffrelId;												$model->RegistrationDate 			=  $curentDate;												$model->BinaryPosition 				=  $BinaryPosition;												$model->ContactNo1 					=  $mobile;												$model->FirstName	 				=  $_POST['Registrations']['FirstName'];												$model->Sex 	 					=  $_POST['Registrations']['Sex'];												$model->PanNo  	 					=  $_POST['Registrations']['PanNo'];												$model->created	 					=  date('Y-m-d');												$model->Status	 					=  0;												$model->Level	 					=  $levels;  												$model->created_by  				= Yii::app()->user->id;																				/*	$photo=CUploadedFile::getInstance($model,'Image');												if ( (is_object($photo) && get_class($photo)==='CUploadedFile')){													$extension  = pathinfo($photo->name, PATHINFO_EXTENSION);													$imageFileName = date('dmyhis').'.'.$extension;;													 $model->Image = $imageFileName;													$photo->saveAs(Yii::app()->basePath .'/../uploads/profile/'.$imageFileName);												 } */																								if($model->save()){													$Rid=Yii::app()->db->lastInsertID;													$checkImidatespo=$this->getImidateSponserCount($reffrelId);													$getsponser=$this->getImidateSponser($reffrelId);													//print_r('<pre>s');   print_r($getsponser[0]['id']);   print_r('</pre>');  exit;													if($checkImidatespo!=0){														if($BinaryPosition=='Right'){															$imedesp	 	= $getsponser['id'];															$connection=Yii::app()->db;															$sql = "UPDATE  sponserdetails SET  RSponserId = '$reffrelId', RNode='$Rid',															RRdate='$curentDate',  RRFee='$pKgAmt', created='$curentDate' WHERE id = '$imedesp'";															$command = $connection->createCommand($sql);															if(!$command->execute()){																$this->loadModel($Rid)->delete();																Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Sponsor Table not update. Please try again!</strong>'); $this->redirect(array('create'));															} 														}else {																$imedesp	 				= $getsponser['id'];																$connection=Yii::app()->db;																$sql = "UPDATE  sponserdetails SET  LSponserId = '$reffrelId', LNode='$Rid', LRdate='$curentDate',																LRFee='$pKgAmt',  created='$curentDate' WHERE id = '$imedesp'";																$command = $connection->createCommand($sql);																if(!$command->execute()){																	$this->loadModel($Rid)->delete();																	Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Sponsor Table not update. Please try again1!</strong>'); $this->redirect(array('create'));																} 														}													} else {														/* insert in sponserdetails table*/														if($BinaryPosition=='Right'){															$query=Yii::app()->db->createCommand()->insert('sponserdetails',															array('RSponserId'=>$_POST['Registrations']['SponserID'], 'ImmediateSponserId'=>$reffrelId,  															'RRFee'=>$pKgAmt, 'RNode'=>$Rid, 'RRdate'=>$curentDate, 'created'=>$curentDate, 'Level'=>$levels));																if(!$query){																	$this->loadModel($Rid)->delete();																	Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Sponsor Table not update. Please try again!</strong>');																	$this->redirect(array('create'));																} 														} else {														  $SponserID=$_POST['Registrations']['SponserID'];														   $query=Yii::app()->db->createCommand()->insert('sponserdetails',														   	   array('LSponserId'=>$SponserID,'ImmediateSponserId'=>$reffrelId, 'LNode'=>$Rid, 															   'LRFee'=>$pKgAmt, 'LRdate'=>$curentDate,'created'=>$curentDate, 'Level'=>$levels));																if(!$query){																	$this->loadModel($Rid)->delete();																	Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Sponsor Table not update. Please try again!</strong>'); $this->redirect(array('create'));																} 														}													}													 ///For Admin update issue date in Pin table														$connection1=Yii::app()->db;														$sqlPincreate = "UPDATE pincreates SET pin_status = '1', issued_rid='$Rid', issued_date='$curentDate' WHERE id = '$pin_id' ";														$commandPincreate = $connection1->createCommand($sqlPincreate);														$commandPincreate->execute();																												$UserQuery=Yii::app()->db->createCommand()->insert('user',														array('username'=>$Rid, 'password'=>$Password, 'user_type'=>'2', 														'usercode'=>$Rid, 'status'=>0, 'created_by'=>Yii::app()->user->id));																												$greensms="Your Registration Has been Completed in STSFS Pvt.Ltd RID $Rid Username : $Rid Password : $Password";														Yii::app()->myclass->sendSMS($mobile,$greensms);															if($bv!=0){															$this->Update_Auto_Bv($Rid, $BinaryPosition, $bv); 															}														$this->Single_Leg($Rid);														//Steppools::model()->UpdateTotalCount();																												Yii::app()->user->setFlash('success', '<i class="fa fa-check-circle"></i><strong> Your Registration Has been 														Completed RID '. $Rid . ' Username : '.$Rid.' Password : '.$Password.'  </strong>');														$this->redirect(array('create'));																																		} else {													Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Registration Process is fail. Please try again!</strong>');													$this->redirect(array('create'));																							}																														} else {													Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> This Referral I.D. '.$reffrelId.' level not define. Please try again..!</strong>');													$this->redirect(array('create'));										}																																										}else {	 											$levelDetails=$this->getLevelByRid($reffrelId);											if($levelDetails!=''){												$levels=($levelDetails)+1;												$model->pin_id  					= $pin_id;												$model->package_id  				= $packageId;												$model->package_amt   				= $pKgAmt;												$model->bv 							= $bv;												$model->Role 						= 'S';												$model->SponserID					=	$reffrelId;												$model->ImmediateSponserId 			=  $reffrelId;												$model->RegistrationDate 			=  $curentDate;												$model->BinaryPosition 				=  $BinaryPosition;												$model->ContactNo1 					=  $mobile;												$model->FirstName	 				=  $_POST['Registrations']['FirstName'];												$model->Sex 	 					=  $_POST['Registrations']['Sex'];												$model->PanNo  	 					=  $_POST['Registrations']['PanNo'];												$model->created	 					=  date('Y-m-d');												$model->Status	 					=  0;												$model->Level	 					=  $levels;  												$model->created_by  				= Yii::app()->user->id;												/*												$photo=CUploadedFile::getInstance($model,'Image');												if ( (is_object($photo) && get_class($photo)==='CUploadedFile')){													$extension  = pathinfo($photo->name, PATHINFO_EXTENSION);													$imageFileName = date('dmyhis').'.'.$extension;;													 $model->Image = $imageFileName;													$photo->saveAs(Yii::app()->basePath .'/../uploads/profile/'.$imageFileName);												 }*/												if($model->save()){													 	$Rid=Yii::app()->db->lastInsertID;														$countSponser=Sponserdetails::model()->chechInsponserIDExistInSponserTable($reffrelId);														if($countSponser!=0){																if($BinaryPosition=='Right'){																$connection=Yii::app()->db;																$sql = "UPDATE  sponserdetails SET  RSponserId = '$reffrelId', RNode='$Rid', 																RRFee='$pKgAmt', RRdate='$curentDate',  created='$curentDate' WHERE ImmediateSponserId = '$reffrelId'";																$command = $connection->createCommand($sql);																if(!$command->execute()){																	$this->loadModel($Rid)->delete();																	Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Sponsor Table not update. Please try again!</strong>');																	$this->redirect(array('registrations/create'));																} 																													}else { 																$connection=Yii::app()->db;																$sql = "UPDATE  sponserdetails SET  LSponserId = '$reffrelId',  LNode='$Rid', 																RRFee='$pKgAmt', RRdate='$curentDate',  created='$curentDate' WHERE ImmediateSponserId = '$reffrelId'";																$command = $connection->createCommand($sql);																if(!$command->execute()){																	$this->loadModel($Rid)->delete();																	Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Sponsor Table not update. Please try again1!</strong>');																	$this->redirect(array('registrations/create'));																} 																												}														} else {															if($BinaryPosition=='Right'){ //Insert New member																$query2=Yii::app()->db->createCommand()->insert('sponserdetails',																array('RSponserId'=>$reffrelId,'ImmediateSponserId'=>$reffrelId, 'RNode'=>$Rid, 																'RRFee'=>$pKgAmt, 'RRdate'=>$curentDate, 'created'=>$curentDate, 'Level'=>$levels));																if(!$query2){																	$this->loadModel($Rid)->delete();																	Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Data not insert in Sponsor Table. Please try again!</strong>'); $this->redirect(array('create'));																} 																													}else { 																$connection=Yii::app()->db;														  		$query=Yii::app()->db->createCommand()->insert('sponserdetails',														   	   array('LSponserId'=>$reffrelId, 'ImmediateSponserId'=>$reffrelId, 'LNode'=>$Rid, 'LRFee'=>$pKgAmt, 															   'LRdate'=>$curentDate, 'created'=>$curentDate, 'Level'=>$levels));																if(!$query){																	$this->loadModel($Rid)->delete();																	Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Data not insert in Sponsor Table. Please try again!</strong>'); $this->redirect(array('create'));																} 																												}														}																									 ///For Admin update issue date in Pin table														$connection1=Yii::app()->db;														$sqlPincreate = "UPDATE pincreates SET pin_status = '1', issued_rid='$Rid', issued_date='$curentDate' WHERE id = '$pin_id' ";														$commandPincreate = $connection1->createCommand($sqlPincreate);														$commandPincreate->execute();														$UserQuery=Yii::app()->db->createCommand()->insert('user',														array('username'=>$Rid, 'password'=>$Password, 'user_type'=>'2', 'usercode'=>$Rid, 'status'=>0, 														'created_by'=>Yii::app()->user->id));																														$greensms="Your Registration Has been Completed in STSFS Pvt.Ltd RID $Rid Username : $Rid Password : $Password";																Yii::app()->myclass->sendSMS($mobile,$greensms);																												if($bv!=0){																$this->Update_Auto_Bv($Rid, $BinaryPosition, $bv); 														}														$this->Single_Leg($Rid);														//Steppools::model()->UpdateTotalCount();																												Yii::app()->user->setFlash('success', '<i class="fa fa-check-circle"></i><strong> 														Your Registration Has been Completed RID '. $Rid . ' Username : '.$Rid.' Password : '.$Password.' 														</strong>');														$this->redirect(array('registrations/create'));												} else {														Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong>  Registration Process fail. Please try again!</strong>'); $this->redirect(array('create'));												}																															} else {												Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> This Referral I.D. '.$reffrelId.' level not define. Please try again..!</strong>'); 												$this->redirect(array('create'));											}									} 								 															                         } 		}		$this->render('create',array('model'=>$model));	}			function actionUpdateTotalCount(){		$stepDetails=Steppools::model()->getSteppoolByDesc();		$i=0;		//echo count($stepDetails); exit;		foreach($stepDetails as $details){			count($stepDetails);			$Rid=$details['Rid'];			$id=$details['id'];			$sql1="SELECT count(*) as totalcount FROM registrations where SponserID='$Rid' and bv!=0 ";				$command1=Yii::app()->db->createCommand($sql1);				$directSponserCount=$command1->queryScalar();			if($i==0){				$connectionUpdate=Yii::app()->db;				$sqlsteppool = "UPDATE steppools SET total_count = '0' where Rid='$Rid' ";				$commandsteppool = $connectionUpdate->createCommand($sqlsteppool);				$commandsteppool->execute();			} else{												$connectionUpdate=Yii::app()->db;				$sqlsteppool = "UPDATE steppools SET total_count ='$i' where Rid='$Rid'   ";				$commandsteppool = $connectionUpdate->createCommand($sqlsteppool);				$commandsteppool->execute();			}		$i++;		}		//exit;	}					function Single_Leg($rid){			/*$sql="update steppools set total_count=total_count+1 where id <1547 ";				$command=Yii::app()->db->createCommand($sql);				$queryArray=$command->execute();*/						$MaxDetail=Steppools::model()->getMaxId();				if($MaxDetail>0){					$positions=intval($MaxDetail)+1;				} else {					echo $positions	=1;				} 				$exist=Steppools::model()->checkExistById($rid);				$sql="SELECT count(*) as totalcount FROM registrations where SponserID='$rid' and bv!=0 ";				$command=Yii::app()->db->createCommand($sql);				$queryArray=$command->queryScalar();				if($exist==0){					 Yii::app()->db->createCommand()->insert('steppools', array('Rid'=>$rid, 'direct_sponser'=>$queryArray, 					 'position_member'=>$positions,					 'amount'=>0, 'steppool_bv'=>0, 'total_count'=>0, 'level'=>'', 'created_date'=>date('Y-m-d'), 'payment_status'=>0, 'sms_status'=>0, 'sms_date'=>date('Y-m-d')));					 $lastid=Yii::app()->db->lastInsertID;					 					 $connectionUpdate=Yii::app()->db;					$sqlsteppool = "UPDATE steppools SET total_count =total_count+1 where id<$lastid   ";					$commandsteppool = $connectionUpdate->createCommand($sqlsteppool);					$commandsteppool->execute();																	$connectionUpdate1=Yii::app()->db;					$sqlsteppool1 = "UPDATE steppools m INNER JOIN ( select SponserID, count(SponserID) as cnt from registrations group by SponserID) c ON m.Rid = c.SponserID SET m.direct_sponser = c.cnt ";					$commandsteppool1 = $connectionUpdate1->createCommand($sqlsteppool1);					$commandsteppool1->execute();									 $sendMobile=Registrations::model()->MobileNoByRID($rid);					$greensms="Dear Associate Congratulation your id(".$rid.") has been entered successfully in Single Leg Tree";					Yii::app()->myclass->sendSMS($sendMobile,$greensms);				}				}					function Update_Auto_Bv($id, $postion, $bv){		ini_set('max_execution_time',220); 		$sponserId=Registrations::model()->getImdiateSponserDetailsByRid($id);		//echo $sponserId['ImmediateSponserId'].'<br>'; 		if(empty($sponserId)){			//echo '<br>You have not any Id'; 		} else {			//print_r($sponserId); exit;			$postioSponser=$sponserId['BinaryPosition'];						$imidateSponser=$sponserId['ImmediateSponserId'];			//echo $imidateSponser.'--->'.$postioSponser;						if($postion=='Left'){				$connectionLeft=Yii::app()->db;				 $sqlLeft = "UPDATE  registrations SET tota_left_bv = tota_left_bv+'$bv' WHERE Rid = '$imidateSponser'";				$commandLeft = $connectionLeft->createCommand($sqlLeft);				$commandLeft->execute();				//echo '<br>';			}				if($postion=='Right'){				$connectionRight=Yii::app()->db;				$sqlRight = "UPDATE  registrations SET total_right_bv=total_right_bv+'$bv'  WHERE Rid = '$imidateSponser'";				$commandRight = $connectionRight->createCommand($sqlRight);				$commandRight->execute();				 //'<br>';			}			$bvDetailsByRid=Registrations::model()->bvDetailsByRid($imidateSponser); 			$lefTotalBV			=	$bvDetailsByRid['tota_left_bv']; 			$righTotaltBV		=	$bvDetailsByRid['total_right_bv'];			$agg_bv=($lefTotalBV < $righTotaltBV)?($lefTotalBV):($righTotaltBV);			$connectionAggBV=Yii::app()->db;			$sqlAgg = "UPDATE  registrations SET total_mbv='$agg_bv'  WHERE Rid = '$imidateSponser'";			$commandAgg = $connectionAggBV->createCommand($sqlAgg);			$commandAgg->execute();			$getPositionArray=Registrations::model()->getImdiateSponserDetailsByRid($imidateSponser);			return $this->Update_Auto_Bv($imidateSponser, $getPositionArray['BinaryPosition'], $bv);					}							}				public function getImidateSponser($referalD){			$sql1="SELECT Sponserdetails.ImmediateSponserId, Sponserdetails.id  FROM sponserdetails AS Sponserdetails  WHERE Sponserdetails.ImmediateSponserId= '$referalD'";			$command1=Yii::app()->db->createCommand($sql1);			$sponsernDetail=$command1->queryRow();			return $sponsernDetail;	}				public function getImidateSponserCount($referalD){		$query = Yii::app()->db->createCommand("SELECT count(*) count FROM sponserdetails AS Sponserdetails 		WHERE Sponserdetails.ImmediateSponserId= '$referalD' ")->queryScalar();		return $query;	}				public function actionCheckName() {   	      if($_POST['Rid']!=''){			  $sql='SELECT  registrations.FirstName FROM registrations WHERE registrations.Rid="'.$_POST['Rid'].'" ';			  $command=Yii::app()->db->createCommand($sql);			  $registrationDetailArray=$command->queryRow();			 // print_r('<pre>');   print_r($registrationDetailArray);   print_r('</pre>'); exit;			  echo $registrationDetailArray['FirstName'];			  		  } else{  return 2;}	}				public function actionDirectMemberlist($search=''){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		//echo Yii::app()->user->getState('usercode'); exit;					$model = new Registrations($scenario='search');		$criteria = new CDbCriteria;		if(isset($_GET['Registrations'])){				$model->attributes=$_GET['Registrations'];				$criteria->addSearchCondition('t.Rid', $_GET['Registrations']['Rid']."%", 0);								$criteria->addSearchCondition('t.FirstName', $_GET['Registrations']['FirstName']."%", 0);				$criteria->addSearchCondition('t.BinaryPosition', $_GET['Registrations']['BinaryPosition']."%", 0);				$criteria->addSearchCondition('t.package_id', "%".$_GET['Registrations']['package_id']."%", 0);			}					$criteria->addSearchCondition('t.SponserID', Yii::app()->user->getState('usercode'), 0);		//$criteria->join = 'left join sponserdetails as s ON s.Rid=t.Rid ';		//$criteria->select = 's.*, t.*';		//$criteria->order = 'Rid DESC';		$dataProvider=new CActiveDataProvider('Registrations', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=> array('id'=>true),  ), 		'pagination' => array ( 'PageSize' => 20,  ) ,		));		$this->render('direct_member_index',array('dataProvider'=>$dataProvider,'model'=>$model));	}			function getMemberList($id){		ini_set('max_execution_time',220); 				if($id==NULL){			return 0;		} else {			$sponserDetail2=Sponserdetails::model()->getLeftNodeRightNode($id);			if(isset($sponserDetail2['LNode'])){				$Lnode2=$sponserDetail2['LNode'];				$memberarray[]=$sponserDetail2['LNode'];			} else {				$Lnode2=0;			}			if(isset($sponserDetail2['RNode'])){				$Rnode2=$sponserDetail2['RNode'];				$memberarray[]=$sponserDetail2['RNode'];			} else {				$Rnode2=0;			}						 return $this->getMemberList($Lnode2)+$this->getMemberList($Rnode2);					}	}		public function actionMemberlist($search=''){			$this->layout = false;			if(Yii::app()->user->id==''){  				Yii::app()->user->setFlash('error', "Please login again!");				$this->redirect(array('/site/login'));			} 			echo $this->getMemberList('10010001'); exit;			$checkPermission=Yii::app()->session['permissions'];			if($checkPermission[0]['lists']!=0){				Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');				$this->redirect(array('/user/dashboard'));			}		$model = new Registrations($scenario='search');		$usercode=Yii::app()->user->getState('usercode');		$criteria = new CDbCriteria;		if(isset($_GET['Registrations'])){				$model->attributes=$_GET['Registrations'];				$criteria->addSearchCondition('t.Rid', $_GET['Registrations']['Rid']."%", 0);											}							$criteria->join = 'left join sponserdetails as s ON s.Rid=t.Rid ';		$criteria->select = 's.*, t.*';		$criteria->addCondition('s.Rid >'.$usercode);		$criteria->order = 't.Rid Asc';						$dataProvider=new CActiveDataProvider('Registrations', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=> array('id'=>true),  ),				'pagination' => array ( 'PageSize' => 20,  ) ,		));		$this->render('member_index',array('dataProvider'=>$dataProvider,'model'=>$model));	}	public function actionMember($search=''){			$this->layout = false;			if(Yii::app()->user->id==''){  				Yii::app()->user->setFlash('error', "Please login again!");				$this->redirect(array('/site/login'));			} 			$checkPermission=Yii::app()->session['permissions'];			if($checkPermission[0]['lists']!=0){				Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');				$this->redirect(array('/user/dashboard'));			}		$model = new Registrations($scenario='search');		$usercode=Yii::app()->user->getState('usercode');		$criteria = new CDbCriteria;		if(isset($_GET['Registrations'])){				$model->attributes=$_GET['Registrations'];				$criteria->addSearchCondition('t.Rid', $_GET['Registrations']['Rid']."%", 0);											//$criteria->addSearchCondition('t.Rid', $_GET['Registrations']['Rid']."%", 0);								$criteria->addSearchCondition('t.id_status', $_GET['Registrations']['id_status']."%", 0);							}										$criteria->join = 'left join sponserdetails as s ON s.Rid=t.Rid ';		$criteria->select = 's.*, t.*';		$criteria->addCondition('s.Rid >'.$usercode);		$criteria->order = 't.Rid Asc';						$dataProvider=new CActiveDataProvider('Registrations', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=> array('id'=>true), ),				'pagination' => array ( 'PageSize' => 50,  ) ,		));		$this->render('memberlist',array('dataProvider'=>$dataProvider,'model'=>$model));	}			public function actionEdit(){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		$checkPermission=Yii::app()->session['permissions'];		if($checkPermission[0]['edits']!=0){			Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');			$this->redirect(array('/user/dashboard'));		}		$model=new Registrations;		$model->setScenario('edit');		$model2=new Bankdetails;		$model2->setScenario('edit');		$updateID=base64_decode($_GET['id']);		$model=$this->loadModel($updateID);		$bankDetail=Bankdetails::model()->findAll(array("condition"=>"Rid =  $updateID"));				//echo '<pre>'; print_r($bankDetail[0]['BankName']); exit;		if(empty($bankDetail)){			$bankDetail='';		} else {			$bankDetail=$bankDetail;		}				if(isset($_POST['Registrations'])){				$model->attributes=$_POST['Registrations'];				$model2->attributes=$_POST['Bankdetails'];				$valid=$model->validate();            				if($model->validate()){						$curentDate	 			= date('Y-m-d H:i:s');						$model->Rid							=	$updateID;						$model->created_by	 				=  Yii::app()->user->id;						$model->PanNo 		 				=  $_POST['Registrations']['PanNo'];						$model->DOB 		 				=  $_POST['Registrations']['DOB'];						$model->FirstName 		 			=  $_POST['Registrations']['FirstName'];						$model->fatherName 		 			=  $_POST['Registrations']['fatherName'];						$model->Occupation 		 			=  $_POST['Registrations']['Occupation'];						$model->MotherName 		 			=  $_POST['Registrations']['MotherName'];						$model->ContactNo1 		 			=  $_POST['Registrations']['ContactNo1'];						$model->Address 		 			=  $_POST['Registrations']['Address'];						$model->City 		 				=  $_POST['Registrations']['City'];						$model->State 		 				=  $_POST['Registrations']['State'];						$model->Country 		 				=  $_POST['Registrations']['Country'];						$model->ZipCode 		 			=  $_POST['Registrations']['ZipCode'];						$photo=CUploadedFile::getInstance($model,'Image');						$model->Emailaddress 		 		=  $_POST['Registrations']['Emailaddress'];						if ( (is_object($photo) && get_class($photo)==='CUploadedFile')){							$extension  = pathinfo($photo->name, PATHINFO_EXTENSION);							$imageFileName = date('dmyhs').'.'.$extension;;							 $model->Image = $imageFileName;							$photo->saveAs(Yii::app()->basePath .'/../uploads/profile/'.$imageFileName);						 }										if($model->save()){												/*insertBank Information */												$countBankDetail = Yii::app()->db->createCommand('SELECT count(*) as count FROM bankdetails AS Bankdetails WHERE Bankdetails.Rid="'.$updateID.'" ')->queryScalar();												if($countBankDetail==0){													$query1=Yii::app()->db->createCommand()->insert('bankdetails',													array('Rid'=>$updateID, 'account_holder'=>$_POST['Bankdetails']['account_holder'], 'AccNo'=>$_POST['Bankdetails']['AccNo'], 'BankName'=>$_POST['Bankdetails']['BankName'], 													'BranchName'=>$_POST['Bankdetails']['BranchName'],'IFSC'=>$_POST['Bankdetails']['IFSC'],													'adhar_no'=>$_POST['Bankdetails']['adhar_no']));												} else {													$AccNo=$_POST['Bankdetails']['AccNo'];													$BankName=$_POST['Bankdetails']['BankName'];													$BranchName=$_POST['Bankdetails']['BranchName'];													$IFSC=$_POST['Bankdetails']['IFSC'];													$adhar_no=$_POST['Bankdetails']['adhar_no'];													$account_holder=$_POST['Bankdetails']['account_holder'];													$connection=Yii::app()->db;													$sql = "UPDATE  bankdetails SET  account_holder = '$account_holder', AccNo = '$AccNo', BankName='$BankName' , BranchName='$BranchName',													IFSC='$IFSC',  adhar_no='$adhar_no' WHERE Rid = '$updateID'";													$command = $connection->createCommand($sql);													$command->execute();												}																								Yii::app()->user->setFlash('success', '<i class="fa fa-check-circle"></i><strong> Update sucessfully!</strong>');												$this->redirect(array('registrations/edit/id/'.$_GET['id']));																																		} else {													Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Update Process fail  . Please try again!</strong>');													$this->redirect(array('registrations/edit/id/'.$_GET['id']));																									}                         } 		} 		$this->render('edit',array('model'=>$model,'model2'=>$model2, 'bankDetail'=>$bankDetail, 'RID'=>$updateID));	}		public function actionUpdateprofile(){		$this->layout = false;		if(Yii::app()->user->id==''){  				Yii::app()->user->setFlash('danger', "Please login again!");				$this->redirect(array('/site/login'));		} 				$model=new Registrations;		$model2=new Bankdetails;		$editId=base64_decode($_GET['id']);				$model=$this->loadModel($editId);		$bankDetail=Bankdetails::model()->findAll(array("condition"=>"Rid =  $editId"));		if(empty($bankDetail)){			$bankDetail='';		} else {		$bankDetail=$bankDetail;		}								if(isset($_POST['Registrations'])){			$model->attributes=$_POST['Registrations'];			if ($model->validate())	{																$model->Emailaddress 	   = $_POST['Registrations']['Emailaddress'];				$model->PanNo 	   = $_POST['Registrations']['PanNo'];				$model->fatherName 	       = $_POST['Registrations']['fatherName'];				$model->MotherName 	       = $_POST['Registrations']['MotherName'];				$model->DOB 	  	       = $_POST['Registrations']['DOB'];				$model->Address 	  	   = $_POST['Registrations']['Address'];								$model->created_by  	       = Yii::app()->user->id;				if($model->save()){					$AccNo=$_POST['Bankdetails']['AccNo'];					$BankName=$_POST['Bankdetails']['BankName'];					$BranchName=$_POST['Bankdetails']['BranchName'];					$IFSC=$_POST['Bankdetails']['IFSC'];					$adhar_no=$_POST['Bankdetails']['adhar_no'];					$account_holder=$_POST['Bankdetails']['account_holder'];					$connection=Yii::app()->db;					$sql = "UPDATE  bankdetails SET  account_holder = '$account_holder', AccNo = '$AccNo', BankName='$BankName' , BranchName='$BranchName',					IFSC='$IFSC',  adhar_no='$adhar_no' WHERE Rid = '$editId'";					$command = $connection->createCommand($sql);					$command->execute();															Yii::app()->user->setFlash('success', 'Profile update successfuly');					$this->redirect(array('/registrations/updateprofile/id/'.$_GET['id']));				} else{					Yii::app()->user->setFlash('danger', 'Not update');				}			} 		}		$this->render('update',array('model'=>$model, 'model2'=>$model2, 'bankDetail'=>$bankDetail));	}		public function getLevelByRid($referalD){		$sql1="SELECT Registration.Level  FROM registrations AS Registration  WHERE Registration.Rid= '$referalD'";		$command=Yii::app()->db->createCommand($sql1);		$queryArray=$command->queryRow();		return $queryArray['Level'];	}	public function getLastNode($referalD , $postion){		$sql1="SELECT Sponserdetails.$postion  FROM sponserdetails AS Sponserdetails  WHERE Sponserdetails.ImmediateSponserId= '$referalD' and Sponserdetails.$postion!= 'NULL' ";		$command1=Yii::app()->db->createCommand($sql1);		$sponsernDetail=$command1->queryRow();		return $sponsernDetail;	}			public function getLastNodeCount($referalD , $postion){		$countSponser = Yii::app()->db->createCommand("SELECT count(*) count FROM sponserdetails AS Sponserdetails WHERE Sponserdetails.ImmediateSponserId= '$referalD' and Sponserdetails.$postion!= 'NULL' ")->queryScalar();		return $countSponser;	}		public function actionCustome_Member($search=''){			$this->layout = false;			if(Yii::app()->user->id==''){  				Yii::app()->user->setFlash('error', "Please login again!");				$this->redirect(array('/site/login'));			} 			$checkPermission=Yii::app()->session['permissions'];			if($checkPermission[0]['lists']!=0){				Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');				$this->redirect(array('/user/dashboard'));			}		$model = new Registrations($scenario='search');		$criteria = new CDbCriteria;		if(isset($_GET['Registrations'])){				$model->attributes=$_GET['Registrations'];				$criteria->addSearchCondition('t.Rid', $_GET['Registrations']['Rid']."%", 0);								$criteria->addSearchCondition('t.SponserID', $_GET['Registrations']['SponserID']."%", 0);				//$criteria->addSearchCondition('t.BinaryPosition', $_GET['Registrations']['BinaryPosition']."%", 0);				$criteria->addSearchCondition('t.FirstName', "%".$_GET['Registrations']['FirstName']."%", 0);				//$criteria->addSearchCondition('t.package_id', "%".$_GET['Registrations']['package_id']."%", 0);			}			if(isset($_GET['id_status'])){		   if($_GET['id_status']==0){			   $criteria->addCondition('t.id_status=0');		   } else {		   	$criteria->addCondition('t.id_status=1');		   }		}				$criteria->join = 'left join sponserdetails as s ON s.Rid=t.Rid ';		$criteria->select = 's.*, t.*';		//$criteria->order = 'Rid DESC';		$dataProvider=new CActiveDataProvider('Registrations', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=> array('id'=>true),  ), 		'pagination' => array ( 'PageSize' => 20,  ) ,		));		$this->render('index',array('dataProvider'=>$dataProvider,'model'=>$model,'idsss'=>1));	}			public function actionProfile(){		$this->layout = false;			if(Yii::app()->user->id==''){  				Yii::app()->user->setFlash('error', "Please login again!");				$this->redirect(array('/site/login'));			} 		if(Yii::app()->user->getState('user_type')==0 || Yii::app()->user->getState('user_type')==3){				$checkPermission=Yii::app()->session['permissions'];				if($checkPermission[0]['view']!=0){					Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');					$this->redirect(array('/user/dashboard'));				}				 $rid=base64_decode($_GET['RID']); 		}			if(Yii::app()->user->getState('user_type')==1){				 $rid=$rid=base64_decode($_GET['RID']); 			} 			if(Yii::app()->user->getState('user_type')==2){				$rid=Yii::app()->user->usercode;			} 		$profileDetails=Registrations::model()->getProfileDetailsByEID($rid);		$this->render('profile',array('profileDetails'=>$profileDetails , 'id'=>$rid));	}		public function actionStatus() {			  $model = Registrations::model()->findByPk($_POST['id']); 		  $status=$model->id_status  =='0' ? '1' : '0';		  //$greenId = Registrations::model()->getGreenId($_POST['id']); 		 // echo $greenId;die;		  $connection=Yii::app()->db;		  $id=$_POST['id'];		  				  		  		  $activation_date=date('Y-m-d');		  $sql = 'UPDATE registrations SET  id_status ="'.$status.'", activation_date="'.$activation_date.'" WHERE Rid ="'.$_POST['id'].'"';		  $command = $connection->createCommand($sql);		  $command->execute();		  		  $sql1 = 'UPDATE registrations SET  green_count=green_count + 1 where Rid < "'.$id.'"';		  $command1 = $connection->createCommand($sql1);		  $command1->execute();		  		  $sql2='select sponserId from sponserdetails where Rid="'.$_POST['id'].'"';		  $command2=Yii::app()->db->createCommand($sql2);		  $sponser=$command2->queryRow();		  		  		  $sql3 = 'UPDATE registrations SET  green_sponser=green_sponser + 1 where Rid="'.$sponser['sponserId'].'"';		  $command3 = $connection->createCommand($sql3);		  $command3->execute();		 				  if($command->execute()==0){	   		   echo 1;		  } else {			  echo 2;		  }	  }	  	  public function actionUpdate_Image(){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		$model=new Registrations;		$model->setScenario('photo');		if(isset($_POST['Registrations'])){				$model->attributes=$_POST['Registrations'];				$rid=Yii::app()->user->usercode; 					$curentDate	 			= date('Y-m-d H:i:s');					$photo=CUploadedFile::getInstance($model,'Image');					if ( (is_object($photo) && get_class($photo)==='CUploadedFile')){						$extension  = pathinfo($photo->name, PATHINFO_EXTENSION);						$imageFileName = date('dmyhis').'.'.$extension;						$photo->saveAs(Yii::app()->basePath .'/../uploads/profile/'.$imageFileName);						$connection=Yii::app()->db;						$sql = "UPDATE  registrations SET  Image = '$imageFileName' WHERE Rid = '$rid'";						$command = $connection->createCommand($sql);						$command->execute();						Yii::app()->user->setFlash('success', '<i class="fa fa-check-circle"></i><strong> Successfully updated </strong>');						$this->redirect(array('/registrations/profile'));					 } else {						 Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Please select image</strong>'); 						 $this->redirect(array('/registrations/update_image'));					 }					 					 							}		$this->render('update_image',array('model'=>$model));	}		//...................................................Report Section Start...........................................	  public function actionReportGreenId()	  {			$this->layout = false;			if(Yii::app()->user->id==''){  				Yii::app()->user->setFlash('error', "Please login again!");				$this->redirect(array('/site/login'));			} 			$checkPermission=Yii::app()->session['permissions'];			if($checkPermission[0]['lists']!=0){				Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');				$this->redirect(array('/user/dashboard'));			}		$model = new Registrations($scenario='search');		$usercode=Yii::app()->user->getState('usercode');		$criteria = new CDbCriteria;				if(isset($_GET['Registrations'])){				$model->attributes=$_GET['Registrations'];			   $criteria->addBetweenCondition('t.activation_date', date('Y-m-d',strtotime($_GET['Registrations']['created'])), date('Y-m-d',strtotime($_GET['Registrations']['activation_date'])));			}			$criteria->addCondition('t.id_status=1');			  				$dataProvider=new CActiveDataProvider('Registrations', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=>'Rid  desc', ), 		'pagination' => array ( 'PageSize' => 50,  ) ,		));		$this->render('report',array('dataProvider'=>$dataProvider,'model'=>$model));		  }	//...........................................................end....................................................	  	 public function loadModel($id)	 {		$model=Registrations::model()->findByPk($id);		if($model===null)			throw new CHttpException(404,'The requested page does not exist.');		return $model;	 }		// Uncomment the following methods and override them if needed	/*	public function filters()	{		// return the filter configuration for this controller, e.g.:		return array(			'inlineFilterName',			array(				'class'=>'path.to.FilterClass',				'propertyName'=>'propertyValue',			),		);	}	public function actions()	{		// return external action classes, e.g.:		return array(			'action1'=>'path.to.ActionClass',			'action2'=>array(				'class'=>'path.to.AnotherActionClass',				'propertyName'=>'propertyValue',			),		);	}	*/}