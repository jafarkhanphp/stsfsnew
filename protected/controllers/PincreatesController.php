<?phpclass PincreatesController extends Controller{	/**	 * @var string the default layout for the views. Defaults to '//layouts/column2', meaning	 * using two-column layout. See 'protected/views/layouts/column2.php'.	 */	//public $layout='main';	/**	 * @return array action filters	 */								/**	 * Displays a particular model.	 * @param integer $id the ID of the model to be displayed	 */	public function actionView($id)	{		$this->render('view',array(			'model'=>$this->loadModel($id),		));	}	/**	 * Creates a new model.	 * If creation is successful, the browser will be redirected to the 'view' page.	 */	public function actionCreate(){		$this->layout= false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");            $this->redirect(array('/site/login'));		} 		$checkPermission=Yii::app()->session['permissions'];		if($checkPermission[0]['adds']!=0){			Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');			$this->redirect(array('/site/dashboard'));		}						$model=new Pincreates;		if(isset($_POST['Pincreates'])){                        $model->attributes=$_POST['Pincreates'];                        $valid=$model->validate();                                    if($valid){							$i = 1;							$pinTotal=$_POST['Pincreates']['no_of_pin'];														while ($i <= $pinTotal) {								$length = 6;								$chars = array_merge(range(0,9));								shuffle($chars);								$uniqueNumber = implode(array_slice($chars, 0,$length));								unset($model->id);								$model->PinNo 			= $uniqueNumber;								$model->amount			=  0;								$model->Status  		= 0; // 							 	$model->transfer_status = 0; //								$model->issued_rid  	= 0; //								$model->user_id  	    = $_POST['Pincreates']['user_id'];							 	$model->created_by  	= Yii::app()->user->id; //user's Id, if you have a login							 	$model->created  		=date('Y-m-d H:i:s');//								$model->isNewRecord = true;								$model->save();								$i++; 							}								Yii::app()->user->setFlash('success', '<i class="fa fa-check-circle"></i><strong> Pin Created Sucessfully!</strong>');								$this->redirect(array('index'));								                         } 		}		$this->render('create',array('model'=>$model,));	}		public function actionPin() {			if($_POST['id']!=''){			  $rid=$_POST['userId'];			$sql='SELECT pincreates.PinNo, pincreates.id FROM pincreates left join pin_master as pinMaster on pinMaster.id=pincreates.pin_master_id			WHERE pinMaster.pkg_id="'.$_POST['id'].'"  and pincreates.pin_status=0 and pincreates.issued_rid=0 and Rid="'.$rid.'" ';			  $command=Yii::app()->db->createCommand($sql);			  $pinDetailArray=$command->queryAll();				  foreach($pinDetailArray as $details){					echo "<option value='".$details['id']."'>".$details['PinNo']."</option>";				  }			} 	}					public function actionUpdate($id)	{		$model=$this->loadModel($id);		// Uncomment the following line if AJAX validation is needed		// $this->performAjaxValidation($model);		if(isset($_POST['Pin']))		{			$model->attributes=$_POST['Pin'];			if($model->save())				$this->redirect(array('view','id'=>$model->id));		}		$this->render('update',array(			'model'=>$model,		));	}	/**	 * Deletes a particular model.	 * If deletion is successful, the browser will be redirected to the 'admin' page.	 * @param integer $id the ID of the model to be deleted	 */	public function actionDelete()	{				 $id=$_POST['id'];					 $checkPermission=Yii::app()->session['permissions'];				if($checkPermission[0]['deletes']!=0){					echo 3;					exit;				}			    $countPintransferTemp = Yii::app()->db->createCommand('SELECT count(*) FROM pincreates WHERE id="'.$id.'" ')->queryScalar();			if($countPintransferTemp==0){				echo $this->loadModel($_POST['id'])->delete();			} else {				echo 2;			}		 	}	/**	 * Lists all models.	 */	public function actionIndex()	{		$this->layout= false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");            $this->redirect(array('/site/login'));		} 		$checkPermission=Yii::app()->session['permissions'];		if($checkPermission[0]['adds']!=0){			Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Permission Denied</strong>');			$this->redirect(array('/user/dashboard'));		}				$model = new Pincreates($scenario='search');		$criteria = new CDbCriteria;		if(isset($_GET['Pincreates'])){				$model->attributes=$_GET['Pincreates'];				$criteria->addSearchCondition('t.PinNo', $_GET['Pincreates']['PinNo']."%", 0);				//$criteria->addSearchCondition('t.transfer_status', $_GET['Pincreates']['transfer_status'], 0);				$criteria->addSearchCondition('t.user_id', $_GET['Pincreates']['user_id'], 0);				//$criteria->addSearchCondition('t.issued_rid', $_GET['Pincreates']['issued_rid']."%", 0);			}			if(Yii::app()->user->getState('user_type')!=0){				$criteria->addSearchCondition('t.user_id', Yii::app()->user->id."%", 0);			}		$dataProvider=new CActiveDataProvider('Pincreates', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=> array('id'=>true),  ), 		'pagination' => array ( 'PageSize' => 100,  ) 		));		$this->render('index',array('dataProvider'=>$dataProvider,'model'=>$model, ));	}	public function actionUser_Pin_History($search=''){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		$model = new Pincreates($scenario='search');		$usercode=Yii::app()->user->getState('usercode');		$criteria = new CDbCriteria;		if(isset($_GET['Pincreates'])){				$model->attributes=$_GET['Pincreates'];				$criteria->addSearchCondition('t.PinNo', $_GET['Pincreates']['PinNo']."%", 0);				$criteria->addSearchCondition('t.issued_rid', $_GET['Pincreates']['issued_rid']."%", 0);					$criteria->addSearchCondition('t.issued_rid', $_GET['Pincreates']['transfer_rid']."%", 0);			}		$criteria->addCondition('t.Rid ='.$usercode);		$dataProvider=new CActiveDataProvider('Pincreates', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=> array('id'=>true),  ),		'pagination' => array ( 'PageSize' => 100,  ) ,		));		$this->render('user_pin_history',array('dataProvider'=>$dataProvider,'model'=>$model));	}		public function actionBucket_index($search=''){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		$model = new Pincreates($scenario='search');		$usercode=Yii::app()->user->getState('usercode');		$criteria = new CDbCriteria;		if(isset($_GET['Pincreates'])){				$model->attributes=$_GET['Pincreates'];				$criteria->addSearchCondition('t.created', $_GET['Pincreates']['created']."%", 0);				$criteria->addSearchCondition('t.transfer_rid', $_GET['Pincreates']['transfer_rid']."%", 0);				$criteria->addSearchCondition('t.PinNo', $_GET['Pincreates']['PinNo']."%", 0);							}		$criteria->addCondition('t.Rid ='.$usercode.' and pin_status=0');		$dataProvider=new CActiveDataProvider('Pincreates', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=> array('id'=>true),  ),		'pagination' => array ( 'PageSize' => 100,  ) ,		));		$this->render('bucket_index',array('dataProvider'=>$dataProvider,'model'=>$model));	}			public function actionPin_Transfer($search=''){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		$model = new Pincreates($scenario='search');		$usercode=Yii::app()->user->getState('usercode');		$pinList=Pincreates::model()->unUsedPinListByRid($usercode);		if(isset($_POST['Pincreates'])){			$sponserID=$_POST['Pincreates']['Rid'];			if($sponserID!=''){				$countRegistration=Registrations::model()->checkSponserId($sponserID);				if($countRegistration==0){					Yii::app()->user->setFlash('danger', '<i class="fa fa-times-circle"></i><strong> Sponser Id not Match!</strong>');					$this->redirect(array('pincreates/pin_transfer'));				}			}			if(!empty($_POST['Pincreates']['trasferstatus'])){				foreach($_POST['Pincreates']['trasferstatus'] as $selectedPin){					$userPin=Pincreates::model()->getPinDeByid($selectedPin);					$pinNp=$userPin['PinNo'];					$pin_master_id=$userPin['pin_master_id'];					$connection=Yii::app()->db;					$user_id=Yii::app()->user->id;					$curentDate=date('Y-m-d');					$sql1 = "insert into pincreates SET PinNo = '$pinNp', Rid='$sponserID', Status = '1',									user_id='$user_id', pin_status='0',  transfer_rid='$usercode', transfer_date='$curentDate', pin_master_id='$pin_master_id',									created_by='$user_id',created='$curentDate'";									$command1 = $connection->createCommand($sql1);									$command1->execute();						$sql = 'update pincreates set pin_status=2 WHERE id="'.$selectedPin.'" ';						$command = $connection->createCommand($sql);						$command->execute();										}				Yii::app()->user->setFlash('success', '<i class="fa fa-check-circle"></i><strong> Pin Transfered Sucessfully!</strong>');				$this->redirect(array('pincreates/pin_transfer'));			}		}					$this->render('pin_transfer',array('model'=>$model, 'pinList'=>$pinList));	}			public function actionPin_Transfer_History($search=''){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		$model = new Pincreates($scenario='search');		$usercode=Yii::app()->user->getState('usercode');		$criteria = new CDbCriteria;		if(isset($_GET['Pincreates'])){				$model->attributes=$_GET['Pincreates'];				$criteria->addSearchCondition('t.PinNo', $_GET['Pincreates']['PinNo']."%", 0);				$criteria->addSearchCondition('t.issued_rid', $_GET['Pincreates']['issued_rid']."%", 0);					$criteria->addSearchCondition('t.issued_rid', $_GET['Pincreates']['transfer_rid']."%", 0);			}		$criteria->addCondition('t.transfer_rid ='.$usercode);		$dataProvider=new CActiveDataProvider('Pincreates', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=> array('id'=>true),  ),		'pagination' => array ( 'PageSize' => 100,  ) ,		));		$this->render('pin_transfer_history',array('dataProvider'=>$dataProvider,'model'=>$model));	}						public function actionPinlist($search=''){		$this->layout = false;		if(Yii::app()->user->id==''){  			Yii::app()->user->setFlash('error', "Please login again!");			$this->redirect(array('/site/login'));		} 		$model = new Pincreates($scenario='search');		$usercode=Yii::app()->user->id;		$criteria = new CDbCriteria;		if(isset($_GET['Pincreates'])){				$model->attributes=$_GET['Pincreates'];				$criteria->addSearchCondition('t.PinNo', $_GET['Pincreates']['PinNo']."%", 0);				$criteria->addSearchCondition('t.issued_rid', $_GET['Pincreates']['issued_rid']."%", 0);							}		//$criteria->addCondition('t.user_id ='.$usercode);				$dataProvider=new CActiveDataProvider('Pincreates', array('criteria' => $criteria,		'sort'=>array( 'defaultOrder'=> array('id'=>true),  ),				'pagination' => array ( 'PageSize' => 100,  ) ,		));		$this->render('pinlist',array('dataProvider'=>$dataProvider,'model'=>$model));	}	/**	 * Manages all models.	 */	public function actionAdmin()	{		$model=new Pin('search');		$model->unsetAttributes();  // clear any default values		if(isset($_GET['Pin']))			$model->attributes=$_GET['Pin'];		$this->render('admin',array(			'model'=>$model,		));	}	/**	 * Returns the data model based on the primary key given in the GET variable.	 * If the data model is not found, an HTTP exception will be raised.	 * @param integer $id the ID of the model to be loaded	 * @return Pin the loaded model	 * @throws CHttpException	 */	public function loadModel($id)	{		$model=Pin::model()->findByPk($id);		if($model===null)			throw new CHttpException(404,'The requested page does not exist.');		return $model;	}protected function performAjaxValidation($model){		if(isset($_POST['ajax']) && $_POST['ajax']==='pin-form')		{			echo CActiveForm::validate($model);			Yii::app()->end();		}	}	}